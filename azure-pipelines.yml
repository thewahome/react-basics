# Node.js with webpack
# Build a Node.js project using the webpack CLI.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  branches:
    include:
    - master
    - releases/*
  tags:
    include:
    - v*

pool:
  vmImage: 'ubuntu-latest' 

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '8.x'
    displayName: 'install Node.js'

  - script: |
      npm install
    displayName: 'npm install'

  - script: |
      npm run build
    displayName: 'build staging assets'

  - task: CopyFiles@2
    displayName: 'copy files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      SourceFolder: '$(System.DefaultWorkingDirectory)/build'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  # Archive files
  # Compress files into .7z, .tar.gz, or .zip
  - task: ArchiveFiles@2
    displayName: 'archive built assets'
    inputs:
      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)' 
      includeRootFolder: true 
      archiveType: 'zip' # Options: zip, 7z, tar, wim
      tarCompression: 'gz' # Optional. Options: gz, bz2, xz, none
      archiveFile: '$(Build.ArtifactStagingDirectory)/react-basics-$(Build.BuildId).zip' 
      replaceExistingArchive: true 
      verbose: true # Optional
    #quiet: # Optional

  - task: GithubRelease@0
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: 'create gitHub release'      
    inputs:
      gitHubConnection: thewahome-github-connection
      repositoryName: thewahome/react-basics
      tagSource: manual
      isPreRelease: true
      tag: $(Build.BuildNumber)      
      assets: |
        $(Build.ArtifactStagingDirectory)/*.zip

  # - task: CopyFiles@2
  #   inputs:
  #     contents: '_buildOutput/**'
  #     targetFolder: $(Build.ArtifactStagingDirectory)
  
  # - task: PublishBuildArtifacts@1
  #   inputs:
  #     pathToPublish: $(Build.ArtifactStagingDirectory)
  #     artifactName: MyBuildOutputs

  # - task: CopyFiles@2
  #   displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
  #   inputs:
  #     SourceFolder: '$(System.DefaultWorkingDirectory)/build'
  #     TargetFolder: '$(Build.ArtifactStagingDirectory)'

  # - task: PublishBuildArtifacts@1
  #   displayName: 'Publish Artifact: drop'

  # - task: GithubRelease@0
  #   displayName: 'Attach Linux x64 artifacts to GitHub Release'
  #   condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
  #   inputs:
  #     gitHubConnection: thewahome-github-connection
  #     repositoryName: Thewahome/react-basics
  #     assets: '$(Build.ArtifactStagingDirectory)/react-basics.tar.gz'
  #     action: edit
  #     target: '$(Build.SourceVersion)'
  #     tag: '$(githubTag)'
  #     addChangeLog: false
  #     assetUploadMode: replace

  # - task: GithubRelease@0
  #   displayName: 'Attach Win x64 artifacts to GitHub Release'
  #   condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
  #   inputs:
  #     gitHubConnection: thewahome-github-connection
  #     repositoryName: Thewahome/react-basics
  #     assets: $(Build.ArtifactStagingDirectory)/react-basics.zip
  #     action: edit
  #     target: '$(Build.SourceVersion)'
  #     tag: $(githubTag)
  #     addChangeLog: true
  #     assetUploadMode: replace
